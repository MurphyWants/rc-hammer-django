{% extends "base.html" %} {% block content %}
<div class="Information">
	<strong> Currently viewing: {{ rc.name }} </strong>
	<ul>
		<li> Date Added: {{ rc.date_added }} </li>
		<li> Last Used: {{ rc.last_used }} </li>
		<li> Car id: {{ rc.id }}</li>
	</ul>

	{% if car_owner %}

	<p> You are the car owner </p>

	<p> <a href="{{ request.path }}/edit/"> Edit this car </a>
		<p>
			<p> <a href="{{ request.path }}/change_password/"> Change the car's password </a>
				<p>

					{% endif %} {% if car_viewer %}

					<p> This car was shared and you can watch </p>

					{% endif %} {% if car_user %}

					<p> This car was shared and you can drive </p>

					{% endif %}
</div>

{% load static %}



<div class="RC_Controls">

	<form>

		<input id="rc_scale" type="range" name="inputRange" min="0" max="100" value="100" oninput="this.form.inputType.value=this.value" />
		<input id="rc_scale_text_box" type="number" name="inputType" min="0" max="100" value="100" oninput="this.form.inputRange.value=this.value" />

	</form>

	</script>


	</br>

	<input id="rc_left" type="button" value="Left" />
	<input id="rc_forward" type="button" value="Forward" />
	<input id="rc_reverse" type="button" value="Reverse" />
	<input id="rc_right" type="button" value="Right" />

	</br>

	<script>
		var roomName = "{{ rc.id }}";

		var control_socket = new WebSocket(
			'ws://' + window.location.host + '/ws/' + roomName + '/control/');

		control_socket.onmessage = function(e) {
			var we_do_nothing_here = e;
		};

		control_socket.onclose = function(e) {
			console.error('Error: socket closed');
		};

		document.querySelector('#rc_left').onclick = function(e) {
			var scale = document.querySelector('#rc_scale').value;
			control_socket.send(JSON.stringify({
				'drive': '180',
				'scale': scale,
			}))
		};

		document.querySelector('#rc_right').onclick = function(e) {
			var scale = document.querySelector('#rc_scale').value;
			control_socket.send(JSON.stringify({
				'drive': '0',
				'scale': scale,
			}))
		};

		document.querySelector('#rc_forward').onclick = function(e) {
			var scale = document.querySelector('#rc_scale').value;
			control_socket.send(JSON.stringify({
				'drive': '90',
				'scale': scale,
			}))
		};


		document.querySelector('#rc_reverse').onclick = function(e) {
			var scale = document.querySelector('#rc_scale').value;
			control_socket.send(JSON.stringify({
				'drive': '270',
				'scale': scale,
			}))
		};

		function toRadians(angle) {
			return angle * (Math.PI / 180);
		};

		function send_control(angle) {
			var scale = document.querySelector('#rc_scale').value;
			control_socket.send(JSON.stringify({
				'drive': angle,
				'scale': scale,
			}))
		};

		function send_control_with_scale(angle, scale) {
			control_socket.send(JSON.stringify({
				'drive': angle,
				'scale': scale,
			}))
		};

		document.onkeydown = function() {
			switch (window.event.keyCode) {
				case 37:
					send_control(180)
					break;
				case 38:
					send_control(90)
					break;
				case 39:
					send_control(0)
					break;
				case 40:
					send_control(270)
					break;
			}
		};

		var haveEvents = 'GamepadEvent' in window;
		var controllers = {};
		var rAF = window.mozRequestAnimationFrame ||
		  window.webkitRequestAnimationFrame ||
		  window.requestAnimationFrame;

		function connecthandler(e) {
		  addgamepad(e.gamepad);
		}
		function addgamepad(gamepad) {

		  controllers[gamepad.index] = gamepad;
		  rAF(updateStatus);
		}

		function disconnecthandler(e) {
		  removegamepad(e.gamepad);
		}

		function removegamepad(gamepad) {
		  delete controllers[gamepad.index];
		}

		function updateStatus() {
		  scangamepads();
		  for (j in controllers) {
		    var controller = controllers[j];
		    if(((controller.axes[1].toFixed(4) > .1) || (controller.axes[1].toFixed(4) < -.1)) && (((controller.axes[0].toFixed(4) > .1) || (controller.axes[0].toFixed(4) < -.1)))){
					var angle = Math.atan2((-1*controller.axes[1].toFixed(4)),controller.axes[0].toFixed(4)) * (180/Math.PI);
		      console.log("Angle: " + angle);
					var scale = 100*Math.abs(controller.axes[3].toFixed(4));
					if (scale < 25){
						scale = 25;
					}
					send_control_with_scale(angle, scale);
		    }

		    if(controller.axes[3].toFixed(4) > .01){
					var input = document.getElementById("rc_scale");
					var input_text = document.getElementById("rc_scale_text_box");

					var scale_value = input.value;

					scale_value = scale_value + .1;

					if (scale_value > 100){
						scale_value = 100;
					}

					document.getElementById("rc_scale").value = scale_value;
					document.getElementById("rc_scale_text_box").value = scale_value;

		      console.log("More: " + scale_value);
		    }

		    if(controller.axes[3].toFixed(4) < -.01){

					var input = document.getElementById("rc_scale");
					var input_text = document.getElementById("rc_scale_text_box");

					var scale_value = input.value;

					scale_value = scale_value - .1;

					if (scale_value < 0){
						scale_value = 0;
					}

					input.innerHTML = scale_value;
					input_text.innerHTML = scale_value;

		      console.log("Less: " + scale_value);
		    }

		  }
		  rAF(updateStatus);
		}

		function scangamepads() {
		  var gamepads = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads() : []);
		  for (var i = 0; i < gamepads.length; i++) {
		    if (gamepads[i]) {
		      if (!(gamepads[i].index in controllers)) {
		        addgamepad(gamepads[i]);
		      } else {
		        controllers[gamepads[i].index] = gamepads[i];
		      }
		    }
		  }
		}

		if (haveEvents) {
		  window.addEventListener("gamepadconnected", connecthandler);
		  window.addEventListener("gamepaddisconnected", disconnecthandler);
		} else {
		  setInterval(scangamepads, 5000);
		}

	</script>

</div>

{% endblock %}
